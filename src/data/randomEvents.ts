// æ¯æœˆéšæœºäº‹ä»¶å®šä¹‰ â€” æš—é»‘èµ„æœ¬å®¶ç‰ˆ
import type { GameState, RandomEvent } from '@/lib/types';

// === æ­£é¢äº‹ä»¶ï¼ˆæš—é»‘ç‰ˆï¼šä½ çš„èŽ·åˆ©å¾€å¾€å»ºç«‹åœ¨åˆ«äººçš„æŸå¤±ä¸Šï¼‰ ===
const positiveEvents: RandomEvent[] = [
  {
    id: 'find_money',
    text: 'ðŸ€ åœ¨è¶…å¸‚åœè½¦åœºæ¡åˆ°ä¸€ä¸ªé’±åŒ…ï¼Œé‡Œé¢æœ‰$200ã€‚å¤±ä¸»å¤§æ¦‚æ­£åœ¨å“­ï¼Œä½†é‚£æ˜¯ä»–çš„é—®é¢˜ã€‚',
    icon: 'ðŸ€',
    tone: 'positive',
    effects: { money: 200 },
    chance: 1,
  },
  {
    id: 'fired_coworker',
    text: 'ðŸ“ˆ åŒäº‹è¢«ç‚’äº†ï¼Œä»–çš„ç­ä½ç»™äº†ä½ ã€‚ä»–çš„ä¸å¹¸å°±æ˜¯ä½ çš„åŠ è–ªã€‚å¤šäº†$500/æœˆã€‚',
    icon: 'ðŸ“ˆ',
    tone: 'positive',
    effects: { money: 500 },
    chance: 0.8,
  },
  {
    id: 'cheap_labor',
    text: 'ðŸ’° æ–°æ¥äº†ä¸€æ‰¹å·æ¸¡å®¢ï¼ŒåŠ³åŠ¨åŠ›è¿‡å‰©ï¼Œä½ çš„è€æ¿è¶æœºåŽ‹äº†ä»–ä»¬çš„ä»·ï¼Œçœä¸‹çš„é’±åˆ†äº†ä½ ä¸€ä»½ã€‚',
    icon: 'ðŸ’°',
    tone: 'positive',
    effects: { money: 300, influence: 3 },
    chance: 0.9,
  },
  {
    id: 'debtor_pays',
    text: 'ðŸ¤‘ ä¸€ä¸ªæ¬ ä½ é’±çš„äººè¢«è›‡å¤´å‚¬å€ºï¼Œå“å¾—å…ˆæŠŠä½ çš„$400è¿˜äº†ã€‚ææƒ§æ˜¯æœ€å¥½çš„å‚¬æ¬¾å·¥å…·ã€‚',
    icon: 'ðŸ¤‘',
    tone: 'positive',
    effects: { money: 400 },
    chance: 0.7,
  },
  {
    id: 'bankrupt_sale',
    text: 'ðŸ·ï¸ æœ‰äººç ´äº§ç”©å–å…¨éƒ¨å®¶å½“ï¼Œä½ ç”¨$200ä¹°äº†ä»·å€¼$1000çš„ä¸œè¥¿è½¬æ‰‹å–äº†ã€‚èµ„æœ¬å®¶çš„ç¬¬ä¸€è¯¾ï¼šä½Žä¹°é«˜å–ã€‚',
    icon: 'ðŸ·ï¸',
    tone: 'positive',
    effects: { money: 800 },
    chance: 0.6,
  },
  {
    id: 'snitch_reward',
    text: 'ðŸ ä½ "ä¸ç»æ„é—´"å‘è€æ¿é€éœ²äº†è°åœ¨å·å·æŽ¥ç§æ´»ã€‚è€æ¿å¾ˆé«˜å…´ï¼Œç»™ä½ æ¶¨äº†å·¥èµ„ã€‚',
    icon: 'ðŸ',
    tone: 'positive',
    effects: { money: 500, san: -5 },
    chance: 0.5,
  },
  {
    id: 'disaster_profit',
    text: 'ðŸŒªï¸ åŠ å·žå¤§ç«å¯¼è‡´æŸä¸ªåŒºåŸŸäººå£å¤–æµã€‚ä½ è¶æœºä½Žä»·æŽ¥äº†ä¸€å•åˆ«äººä¸æ•¢åšçš„æ´»ï¼Œå¤§èµšä¸€ç¬”ã€‚',
    icon: 'ðŸŒªï¸',
    tone: 'positive',
    effects: { money: 1200 },
    chance: 0.4,
  },
  {
    id: 'replace_deported',
    text: 'ðŸš” ICEå¸¦èµ°äº†ä¸€ä¸ªå·¥å‹ã€‚ä»–çš„èŒä½ã€ä»–çš„å®¢æˆ·ã€ä»–çš„è·¯çº¿â€¦â€¦å…¨éƒ½é¡ºç†æˆç« åœ°æˆäº†ä½ çš„ã€‚',
    icon: 'ðŸš”',
    tone: 'positive',
    effects: { money: 600, influence: 5 },
    chance: 0.7,
  },
  {
    id: 'loan_shark_cut',
    text: 'ðŸ¦ˆ ä½ å¸®ä¸€ä¸ªè›‡å¤´åšäº†ç‚¹å°å¿™ï¼Œä»–ç»™äº†ä½ $800"èŒ¶æ°´è´¹"ã€‚ä»–è¯´ä»¥åŽæœ‰äº‹å¯ä»¥æ‰¾ä½ ã€‚',
    icon: 'ðŸ¦ˆ',
    tone: 'positive',
    effects: { money: 800, san: -8 },
    chance: 0.4,
  },
  {
    id: 'fear_profit',
    text: 'ðŸ˜° ç¤¾åŒºé‡Œäººå¿ƒæƒ¶æƒ¶éƒ½åœ¨å›¤ç‰©èµ„ï¼Œä½ æå‰è¿›äº†ä¸€æ‰¹è´§é«˜ä»·å–å‡ºï¼Œå‡€èµš$600ã€‚ææ…Œæ˜¯é—¨å¥½ç”Ÿæ„ã€‚',
    icon: 'ðŸ˜°',
    tone: 'positive',
    effects: { money: 600 },
    chance: 0.5,
  },
  {
    id: 'dead_mans_job',
    text: 'âš°ï¸ æœ‰ä¸ªå·¥å‹"ä¸æ¥äº†"ï¼ˆæ®è¯´æ˜¯å‡ºäº†äº‹ï¼‰ï¼Œä»–çš„é«˜è–ªå²—ä½ç©ºå‡ºæ¥äº†ã€‚ä½ æ¯«ä¸çŠ¹è±«åœ°é¡¶ä¸Šã€‚',
    icon: 'âš°ï¸',
    tone: 'positive',
    effects: { money: 800, san: -3 },
    chance: 0.6,
  },
];

// === è´Ÿé¢äº‹ä»¶ï¼ˆçŽ©å®¶ä¹Ÿä¼šå—è‹¦ï¼Œä½†ç¨‹åº¦æ¯”åˆ«äººè½»å¾—å¤šï¼‰ ===
const negativeEvents: RandomEvent[] = [
  {
    id: 'caught_cold',
    text: 'ðŸ¤§ æ„Ÿå†’äº†ã€‚ä½†è‡³å°‘ä½ çœ‹å¾—èµ·åŒ»ç”Ÿâ€”â€”ä¸åƒéš”å£é‚£ä¸ªæ‰›äº†ä¸€å‘¨ç›´æŽ¥è¿›ICUçš„ã€‚',
    icon: 'ðŸ¤§',
    tone: 'negative',
    effects: { health: -8, money: -100 },
    chance: 1,
  },
  {
    id: 'protection_fee',
    text: 'ðŸ”ª æœ‰äººæ¥æ”¶"ä¿æŠ¤è´¹"ã€‚ä½ ä»˜äº†$300ã€‚è¿™å°±æ˜¯ä¸›æž—æ³•åˆ™â€”â€”ä½ è¦ä¹ˆæ˜¯äº¤é’±çš„ï¼Œè¦ä¹ˆæ˜¯æ”¶é’±çš„ã€‚',
    icon: 'ðŸ”ª',
    tone: 'negative',
    effects: { money: -300, san: -5 },
    chance: 0.8,
  },
  {
    id: 'identity_scare',
    text: 'ðŸ‘® è·¯ä¸Šè¢«è­¦å¯Ÿç›˜é—®äº†ã€‚ä½ å‡è£…é•‡å®šï¼Œç”¨æµåˆ©çš„è‹±è¯­å¯¹ç­”å¦‚æµã€‚å·®ç‚¹å“æ­»ï¼Œä½†è¿‡äº†ã€‚å¼±è€…æ²¡æœ‰è¿™ä¸ªè¿æ°”ã€‚',
    icon: 'ðŸ‘®',
    tone: 'negative',
    effects: { san: -15 },
    chance: 0.9,
  },
  {
    id: 'scammed_small',
    text: 'ðŸ˜¤ è¢«ä¸€ä¸ª"è€ä¹¡"éª—äº†$200ã€‚ä½†ä½ è®°ä½äº†ä»–çš„è„¸â€”â€”æ€»æœ‰ä¸€å¤©ä½ ä¼šè®©ä»–åŠ å€å¥‰è¿˜ã€‚',
    icon: 'ðŸ˜¤',
    tone: 'negative',
    effects: { money: -200, san: -5 },
    chance: 0.7,
  },
  {
    id: 'guilt_dream',
    text: 'ðŸ˜± åŠå¤œåšäº†å™©æ¢¦ï¼šæ¢¦åˆ°äº†é‚£äº›æ¶ˆå¤±çš„äººçš„è„¸ã€‚ä½ ç¿»äº†ä¸ªèº«ç»§ç»­ç¡â€”â€”$100,000çš„åºŠåž«ç¡®å®žèˆ’æœã€‚',
    icon: 'ðŸ˜±',
    tone: 'negative',
    effects: { san: -12 },
    chance: 0.6,
  },
  {
    id: 'rent_increase',
    text: 'ðŸ  æˆ¿ä¸œæ¶¨ç§Ÿäº†ã€‚ä½†ä½ æ¶¨å¾—èµ·â€”â€”ä¸åƒé‚£äº›è¢«èµ¶åˆ°è¡—ä¸ŠåŽ»çš„äººã€‚',
    icon: 'ðŸ ',
    tone: 'negative',
    effects: { money: -200 },
    chance: 0.8,
  },
  {
    id: 'bad_investment',
    text: 'ðŸ“‰ ä¸€ç¬”å°æŠ•èµ„äºäº†$500ã€‚æ— æ‰€è°“ï¼Œè¿™æ˜¯å­¦è´¹ã€‚é‚£äº›æŠŠå…¨éƒ¨èº«å®¶èµŒè¿›åŽ»çš„äººæ‰çœŸæƒ¨ã€‚',
    icon: 'ðŸ“‰',
    tone: 'negative',
    effects: { money: -500 },
    chance: 0.6,
  },
  {
    id: 'conscience_pang',
    text: 'ðŸ’­ è·¯è¿‡ä¸€ä¸ªæµæµªæ±‰ï¼Œä»–å«ä½ çš„åå­—â€”â€”æ˜¯ä½ ä¸‰ä¸ªæœˆå‰ä¸€èµ·æ‰“å·¥çš„äººã€‚ä½ åŠ å¿«è„šæ­¥èµ°äº†ã€‚',
    icon: 'ðŸ’­',
    tone: 'negative',
    effects: { san: -10 },
    chance: 0.7,
  },
];

// === æžç«¯äº‹ä»¶ï¼ˆæš—é»‘ç‰ˆï¼šæžç«¯çš„å¥½è¿å¾€å¾€ä¼´éšç€æžç«¯çš„ç½ªæ¶ï¼‰ ===
const extremeEvents: RandomEvent[] = [
  {
    id: 'ice_raid_profit',
    text: 'ðŸš¨ ICEå¤§æ‰«è¡ï¼Œä½ çš„ç«žäº‰å¯¹æ‰‹å…¨è¢«æŠ“äº†ã€‚ä½ å®‰å…¨åœ°ååœ¨å®¶é‡Œæ•°é’±ã€‚è¡Œä¸šç©ºç™½æœŸ=æš´åˆ©æœŸã€‚',
    icon: 'ðŸš¨',
    tone: 'positive',
    effects: { money: 3000, influence: 10 },
    chance: 0.12,
  },
  {
    id: 'mass_layoff_up',
    text: 'ðŸ­ å·¥åŽ‚å¤§è£å‘˜ï¼Œ50äººè¢«èµ¶èµ°äº†ã€‚ä½ ä¸ä»…æ²¡è¢«è£ï¼Œè¿˜å› ä¸º"è¡¨çŽ°ä¼˜å¼‚"å‡äº†èŒåŠ äº†è–ªã€‚',
    icon: 'ðŸ­',
    tone: 'positive',
    effects: { money: 2000, influence: 5 },
    chance: 0.1,
  },
  {
    id: 'windfall_dark',
    text: 'ðŸ’€ ä¸€ä¸ªè®¤è¯†çš„äººçªç„¶"æ¶ˆå¤±"äº†ã€‚ä»–æ¬ ä½ çš„é’±æ²¡æ¥å¾—åŠè¦å›žæ¥ï¼Œä½†ä½ ä»Žä»–çš„åœˆå­é‡ŒæŽ¥æ‰‹äº†ä»·å€¼$5,000çš„ç”Ÿæ„ã€‚',
    icon: 'ðŸ’€',
    tone: 'positive',
    effects: { money: 5000, san: -15 },
    chance: 0.06,
  },
  {
    id: 'community_collapse',
    text: 'ðŸ”¥ é™„è¿‘çš„åŽäººç¤¾åŒºå‡ºäº†å¤§äº‹ï¼ˆç«ç¾/æ‰«è¡ï¼‰ï¼Œå¤§é‡äººå‘˜å¤–æµã€‚ä½ è¶ä¹±ä½Žä»·æ”¶è´­äº†ä»–ä»¬çš„è®¾å¤‡å’Œåº“å­˜ã€‚',
    icon: 'ðŸ”¥',
    tone: 'positive',
    effects: { money: 4000, san: -10 },
    chance: 0.08,
  },
  {
    id: 'earthquake_opportunity',
    text: 'ðŸŒ åœ°éœ‡äº†ï¼å—ç¾åŒºåŸŸæ€¥éœ€ç‰©èµ„ã€‚ä½ å›¤ç§¯çš„è´§ç‰©ç¿»äº†ä¸‰å€ä»·æ ¼å‡ºæ‰‹ã€‚å‘ç¾éš¾è´¢ï¼Œä½†åˆæ³•ã€‚',
    icon: 'ðŸŒ',
    tone: 'positive',
    effects: { money: 3500, san: -8 },
    chance: 0.07,
  },
  {
    id: 'hospital_bill_you',
    text: 'ðŸ¥ ä½ ä¹Ÿè¿›äº†ä¸€æ¬¡æ€¥è¯Šã€‚$3000çš„è´¦å•ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¦èµšæ›´å¤šçš„é’±â€”â€”å› ä¸ºåœ¨è¿™ä¸ªå›½å®¶ï¼Œç©·äººè¿žç”Ÿç—…çš„èµ„æ ¼éƒ½æ²¡æœ‰ã€‚',
    icon: 'ðŸ¥',
    tone: 'extreme',
    effects: { money: -3000, health: -15 },
    chance: 0.1,
  },
  {
    id: 'betrayal',
    text: 'ðŸ—¡ï¸ è¢«ä½ ä¿¡ä»»çš„äººèƒŒåŽæ…äº†ä¸€åˆ€ï¼Œå·äº†ä½ $2000ã€‚ä½ å‘èª“ä¸ä¼šå†ä¿¡ä»»ä»»ä½•äººã€‚è¿™æ‰æ˜¯åœ¨ç¾Žå›½æ´»ä¸‹åŽ»çš„æ­£ç¡®å§¿åŠ¿ã€‚',
    icon: 'ðŸ—¡ï¸',
    tone: 'extreme',
    effects: { money: -2000, san: -20 },
    chance: 0.1,
  },
  {
    id: 'close_call',
    text: 'ï¿½ å·®ä¸€ç‚¹å°±æ˜¯ä½ ã€‚é‚£æ¬¡æ‰«è¡ã€é‚£åœºäº‹æ•…ã€é‚£æ¬¡çˆ†ç‚¸â€”â€”ä½ æ´»ä¸‹æ¥äº†ã€‚æœ‰äº›äººæ²¡é‚£ä¹ˆå¹¸è¿ã€‚',
    icon: 'ï¿½',
    tone: 'extreme',
    effects: { san: -25, luck: 20 },
    chance: 0.12,
  },
];

/**
 * æ¯æœˆç»“ç®—æ—¶ç”Ÿæˆéšæœºäº‹ä»¶
 * æš—é»‘ç‰ˆæ¦‚çŽ‡åˆ†å¸ƒè°ƒæ•´ï¼šæ­£é¢äº‹ä»¶æ›´å¤šï¼ˆä½ æ˜¯å¹¸è¿çš„èµ„æœ¬å®¶ï¼‰
 */
export function rollRandomEvent(state: GameState): RandomEvent | null {
  const roll = Math.random();

  // 55%æ¦‚çŽ‡ä»€ä¹ˆéƒ½ä¸å‘ç”Ÿ
  if (roll > 0.45) return null;

  let pool: RandomEvent[];
  if (roll < 0.06) {
    // 6%æžç«¯äº‹ä»¶
    pool = extremeEvents;
  } else if (roll < 0.18) {
    // 12%è´Ÿé¢äº‹ä»¶ï¼ˆä½ å¾ˆå°‘å—è‹¦ï¼‰
    pool = negativeEvents;
  } else {
    // 27%æ­£é¢äº‹ä»¶ï¼ˆä½ æ€»æ˜¯å¹¸è¿çš„ï¼‰
    pool = positiveEvents;
  }

  // æ ¹æ®æƒé‡é€‰å–
  const totalWeight = pool.reduce((s, e) => s + e.chance, 0);
  let pick = Math.random() * totalWeight;
  for (const event of pool) {
    pick -= event.chance;
    if (pick <= 0) return event;
  }
  return pool[pool.length - 1];
}
